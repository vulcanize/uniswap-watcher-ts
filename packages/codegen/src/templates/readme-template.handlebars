# {{contractName}} Watcher

## Setup

* Run the following command to install required packages:

  ```bash
  yarn
  ```

* Create a postgres12 database for the watcher:

  ```bash
  sudo su - postgres
  createdb {{folderName}}
  ```

* If the watcher is an `active` watcher:

  Create database for the job queue and enable the `pgcrypto` extension on them (https://github.com/timgit/pg-boss/blob/master/docs/usage.md#intro):

  ```
  createdb {{folderName}}-job-queue
  ```

  ```
  postgres@tesla:~$ psql -U postgres -h localhost {{folderName}}-job-queue
  Password for user postgres:
  psql (12.7 (Ubuntu 12.7-1.pgdg18.04+1))
  SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)
  Type "help" for help.

  {{folderName}}-job-queue=# CREATE EXTENSION pgcrypto;
  CREATE EXTENSION
  {{folderName}}-job-queue=# exit
  ```

* Update the [config](./environments/local.toml) with database connection settings.

* Update the `upstream` config in the [config file](./environments/local.toml) and provide the `ipld-eth-server` GQL API and the `indexer-db` postgraphile endpoints.

* Update the [config](./environments/local.toml) with derived state checkpoint settings.

## Customize

* Indexing on an event:

  * Edit the custom hook function `handleEvent` (triggered on an event) in [hooks.ts](./src/hooks.ts) to perform corresponding indexing using the `Indexer` object.

  * While using the indexer storage methods for indexing, pass the optional arg. `defaultStateKind` as `diff` or `checkpoint` if default derived state is desired to be generated using the state variables being indexed.

* Derived state:

  * Edit the custom hook function `createInitialCheckpoint` (triggered on watch-contract, checkpoint: `true`) in [hooks.ts](./src/hooks.ts) to save an initial checkpoint `IPLDBlock` using the `Indexer` object.

  * Edit the custom hook function `createStateDiff` (triggered on a block) in [hooks.ts](./src/hooks.ts) to save the derived state in an `IPLDBlock` using the `Indexer` object. The default derived state (if exists) is updated.

* The existing example hooks in [hooks.ts](./src/hooks.ts) are for an `ERC20` contract.

## Run

* Run the watcher:

  ```bash
  yarn server
  ```

GQL console: http://localhost:3008/graphql

* If the watcher is an `active` watcher:

  * Run the job-runner:

    ```bash
    yarn job-runner
    ```

  * To watch a contract:

    ```bash
    yarn watch:contract --address <contract-address> --kind <contract-kind> --checkpoint <true | false> --starting-block [block-number]
    ```

  * To fill a block range:

    ```bash
    yarn fill --start-block <from-block> --end-block <to-block>
    ```

  * To create a checkpoint for a contract:

    ```bash
    yarn checkpoint --address <contract-address> --block-hash [block-hash]
    ```
  
  * While watching the contract using the `watchContract` mutation or the CLI:
  
    * Pass `checkpoint` flag as `true` to turn checkpointing on for that contract.

    * If the contract to be watched has an identifier, pass the identifier as `address` instead of the contract address.
    
      * In such case, either the kind needs to be passed as `protocol` or necessary changes can be made in `watchContract()` in [indexer.ts](./src/indexer.ts)

      * Example:

        * Contract identifier: `MyProtocol`.
        * Kind: `demo-protocol`.
        * Changes in `watchContract()`:

          ```ts
          const contractAddress = (kind === 'demo-protocol') ? address : ethers.utils.getAddress(address);
          ```
